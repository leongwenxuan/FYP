{% extends 'base.html' %}

{% block title %}Report Issue{% endblock %}

{% block extra_head %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Report Accessibility Issue</h2>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Location Preview</h5>
            <div id="map" style="height: 400px;" class="mb-3"></div>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="useCurrentLocation()">
                <i class="fas fa-location-arrow me-1"></i> Use Current Location
            </button>
        </div>
    </div>
    
    <div class="row">
            <div class="card">
                <div class="card-body">
                    <form id="issueForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <div class="input-group">
                                <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                                <button type="button" class="btn btn-outline-primary" id="voiceInputBtn">
                                    <i class="fas fa-microphone">Record</i>
                                </button>
                            </div>
                            <div id="voiceStatus" class="form-text text-muted"></div>
                        </div>

                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="location" name="location" required>
                                <button type="button" class="btn btn-outline-primary" onclick="useCurrentLocation()">
                                    <i class="fas fa-location-arrow"></i> Use My Location
                                </button>
                            </div>
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                        </div>

                        <div class="mb-3">
                            <label for="priority" class="form-label">Priority Level</label>
                            <select class="form-select" id="priority" name="priority" required>
                                <option value="1">Low</option>
                                <option value="2">Medium</option>
                                <option value="3">High</option>
                                <option value="4">Critical</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="image" class="form-label">Upload Image (Optional)</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                            <div id="imagePreview" class="mt-2"></div>
                        </div>

                        <button type="submit" class="btn btn-primary">Submit Report</button>
                    </form>
                </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let map;
let marker;
let autocomplete;

function initMap() {
    // Default to Singapore coordinates
    const defaultLocation = { lat: 1.3521, lng: 103.8198 };
    
    map = new google.maps.Map(document.getElementById('map'), {
        center: defaultLocation,
        zoom: 12
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                map.setCenter(userLocation);

                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    title: 'Your Location'
                });
            }
        );
    }
    geocoder = new google.maps.Geocoder(); 

    marker = new google.maps.Marker({
        map: map,
        draggable: true
    });

    // Initialize the autocomplete
    autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('location'),
        { componentRestrictions: { country: 'sg' } }
    );

    // Update marker when place is selected
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        updateMarkerPosition(place.geometry.location);
    });

    // Update coordinates when marker is dragged
    marker.addListener('dragend', () => {
        const position = marker.getPosition();
        updateFormCoordinates(position);
        reverseGeocode(position);
    });
}

function updateMarkerPosition(location) {
    marker.setPosition(location);
    map.setCenter(location);
    map.setZoom(16);
    updateFormCoordinates(location);
}

function updateFormCoordinates(location) {
    document.getElementById('latitude').value = Number(location.lat()).toFixed(6);
    document.getElementById('longitude').value = Number(location.lng()).toFixed(6);
}


function reverseGeocode(position) {
    geocoder.geocode({ location: position }, (results, status) => {
        if (status === 'OK' && results[0]) {
            document.getElementById('location').value = results[0].formatted_address;
        }
    });
}

function useCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Update marker and map
                updateMarkerPosition(new google.maps.LatLng(location.lat, location.lng));
                
                // Get address for the location
                geocoder.geocode({ location }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('location').value = results[0].formatted_address;
                    } else {
                        console.error('Geocoder failed:', status);
                        document.getElementById('location').value = `${location.lat}, ${location.lng}`;
                    }
                });
            },
            error => {
                console.error('Error getting location:', error);
                alert('Unable to get your location. Please try again or enter it manually.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

// Handle image preview
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `
                <img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px">
            `;
        }
        reader.readAsDataURL(file);
    }
});

// Handle form submission
document.getElementById('issueForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

        // Debug logs
        console.log("Form Data Contents:");
    for (let pair of formData.entries()) {
        console.log(pair[0], pair[1]);
    }
    
    
    try {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const response = await axios.post('/api/issues/', formData, {
            headers: {
                'Content-Type': 'multipart/form-data',
                'X-CSRFToken': csrftoken
            }
        });
        
        // Redirect to the issue detail page
        window.location.href = `/issues/${response.data.id}`;
    } catch (error) {
    console.error('Error submitting issue:', error);
    if (error.response) {
        console.error('Server Error Details:', error.response.data);
    }
    alert('Error submitting issue. Please try again.');
}
});

// Voice input functionality
let isRecording = false;
let mediaRecorder;
let audioChunks = [];

document.getElementById('voiceInputBtn').addEventListener('click', toggleVoiceInput);

async function toggleVoiceInput() {
    const voiceBtn = document.getElementById('voiceInputBtn');
    const statusDiv = document.getElementById('voiceStatus');
    
    if (!isRecording) {
        // Start recording
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            statusDiv.textContent = "Listening... (Click again to stop)";
            voiceBtn.classList.add('btn-danger');
            voiceBtn.classList.remove('btn-outline-primary');
            
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.addEventListener('dataavailable', event => {
                audioChunks.push(event.data);
            });
            
            mediaRecorder.addEventListener('stop', async () => {
                statusDiv.textContent = "Processing your voice input...";
                
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio', audioBlob);
                
                try {
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const response = await axios.post('/api/transcribe-audio/', formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                            'X-CSRFToken': csrftoken
                        }
                    });
                    
                    if (response.data.success) {
                        // Fill form fields based on the structured data
                        const result = response.data.result;
                        
                        if (result.title) document.getElementById('title').value = result.title;
                        if (result.description) document.getElementById('description').value = result.description;
                        if (result.location) document.getElementById('location').value = result.location;
                        if (result.priority) document.getElementById('priority').value = result.priority;
                        
                        statusDiv.textContent = "Form populated from your voice input!";
                    } else {
                        statusDiv.textContent = "Error processing voice input. Please try again.";
                    }
                } catch (error) {
                    console.error('Error processing audio:', error);
                    statusDiv.textContent = "Error processing voice input. Please try again.";
                }
                
                voiceBtn.classList.remove('btn-danger');
                voiceBtn.classList.add('btn-outline-primary');
            });
            
            mediaRecorder.start();
            isRecording = true;
        } catch (error) {
            console.error('Error accessing microphone:', error);
            statusDiv.textContent = "Error accessing microphone. Please check permissions.";
        }
    } else {
        // Stop recording
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
    }
}

// Initialize map when page loads
window.addEventListener('load', initMap);
</script>
{% endblock %} 